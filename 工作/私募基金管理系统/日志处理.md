[TOC]

## 一、 日志级别

本节讲述日志级别的基本概念，旨在在开发过程中开发人员能够根据不同的情况，选择合适的日志级别打印日志。什么时候打印日志，也就是日志打印时机，在下一节当中描述。

### 日志级别的标准顺序及简要说明

ALL < TRACE < DEBUG < INFO < WARN < ERROR < FATAL < OFF

> fatal - 严重的，造成服务中断的错误； 
>
> error - 其他错误运行期错误，在各方法的catch块中使用； 
>
> warn - 警告信息，如程序调用了一个即将作废的接口，接口的不当使用，运行状态不是期望的但仍可继续处理等；
>
> info - 有意义的事件信息，如程序启动，关闭事件，收到请求事件等；
>
> debug - 调试信息，可记录详细的业务处理到哪一步了，以及当前的变量状态； 
>
> trace - 更详细的跟踪信息。

一般常用的日志级别为`DEBUG、INFO、WARN、ERROR`。

- ERROR：系统发生了错误事件，但仍然不影响系统的继续运行。系统需要将错误或异常细节记录ERROR日志中，方便后续人工回溯解决。
- WARN： 系统在业务处理时触发了异常流程(参数验证不过)，但系统可恢复到正常态，下一次业务可以正常执行。如程序调用了一个旧版本的接口，可选参数不合法，非业务预期的状态但仍可继续处理等
- INFO： 记录系统关键信息，旨在保留系统正常工作期间关键运行指标，开发人员可以将初始化系统配置、业务状态变化信息，或者用户业务流程中的核心处理记录到INFO日志中，方便日常运维工作以及错误回溯时上下文场景复现
- DEBUG： 可以将各类详细信息记录到DEBUG里，起到调试的作用，包括参数信息，调试细节信息，返回值信息等。



## 二、日志打印时机

此版本的"日志打印时机"**并非最终版**，之后会根据在业务开发过程当中遇到的一些实际情况对本小节的内容进行持续的更新。本小节的目标是：**让开发人员明确应该在具体的哪类文件中的哪些位置合理的打印日志**。

现在，开发人员可根据"**日志打印级别**"和"**日志打印时机**"两小节的内容来**大致明确**应该在系统的什么位置打印什么级别的日志。在本小节相对完善后，开发人员能够根据本小节的内容，找到非常合理的日志打印时机。

### 系统初始化

系统初始化时会依赖一些关键配置，根据参数不同会提供不一样的服务。**将系统的启动参数记录INFO日志**，打印出参数以及服务启动完成状态。

### 业务流程与预期不符

系统中结果与期望不符，应当记录日志。常见的合适场景包括外部参数不正确，数据处理问题导致返回码不在合理范围内等等。

### 系统核心的关键动作

系统中核心角色触发的业务动作是需要多加关注的，是衡量系统正常运行的重要指标，**建议记录INFO级别日志**。

### 捕获到异常时

这类捕获的异常是系统告知开发人员需要加以关注的，应当记录日志，**根据实际情况使用warn或者error级别**。

### 外部接口日志（在我们的系统中还不常见）

这类日志涉及到与外部系统的交互，事关责任问题，建议将原始数据文件内容写入日志或数据库（如mongodb），核心处理逻辑关键业务数据也尽量写入日志。如果涉及到重发，建议将处理失败的原始数据文件日志写入数据库，以便重发执行。



## 三、日志规约

以下为在系统开发过程中，开发人员需要遵守的日志规约。其中：

* 【强制】表示是必须遵守的规约
* 【推荐】表示是应该遵守的规约
* 【参考】表示在某些业务场景下，会发生二者皆可的情况，采用【参考】会让日志的打印更合理与规范

1. 【强制】应用中不可直接使用日志系统(Log4j、Logback)中的 API，而应依赖使用日志框架`SLF4J`中的 API，使用门面模式的日志框架，有利于维护和各个类的日志处理方式统一。

   ```java
   import org.slf4j.Logger;
   import org.slf4j.LoggerFactory;
   private static final Logger logger = LoggerFactory.getLogger(Abc.class);
   ```

   也可使用Lombok的注解`@SLF4J`

2. 【强制】日志文件推荐至少保存 **15 天**，因为有些异常具备以“周”为频次发生的特点。

   > 这个保存时间要根据不同项目的特点确定

3. 【强制】应用中的扩展日志(如打点、临时监控、访问日志等)命名方式: `appName_logType_logName.log`。

   logType:日志类型，推荐分类有

   * stats
   * desc
   * monitor
   * visit 等;

   logName:日志描述。

   这种命名的好处:通过文件名就可知 道日志文件属于什么应用，什么类型，什么目的，也有利于归类查找。

4. 【强制】对 trace/debug/info 级别的日志输出，必须使用条件输出形式或者使用占位符的方式。推荐使用占位符的方式，代码相对简洁。

   > 说明：
   >
   > logger.debug("Processing trade with id: " + id + " and symbol: " + symbol); 
   >
   > 如果日志级别是 warn，上述日志不会打印，但是会执行字符串拼接操作，如果 symbol 是对象， 会执行 toString()方法，浪费了系统资源，执行了上述操作，最终日志却没有打印。

   

5. 【强制】避免重复打印日志，浪费磁盘空间，务必在 log4j.xml 中设置 additivity=false。

   ```xml
   <logger name="com.taobao.dubbo.config" additivity="false">
   ```

6. 【强制】异常信息应该包括两类信息

   * 案发现场信息
   * 异常堆栈信息

   如果不处理，那么通过 关键字 throws 往上抛出。

   ```java
   logger.error(各类参数或者对象toString + "_" + e.getMessage(), e);
   ```

7. 【推荐】谨慎地记录日志。

   * 生产环境禁止输出 `debug` 日志
   * 有选择地输出` info `日志
   * 如果使 用` warn `来记录刚上线时的业务行为信息，一定要注意日志输出量的问题，避免把服务器磁盘 撑爆，并记得及时删除这些观察日志。

8. 【参考】可以使用` warn `日志级别来记录**用户输入参数错误**的情况，避免用户投诉时，无所适从。注意日志输出的级别，`error` 级别只记录**系统逻辑出错、异常等重要的错误信息**。如非必 要，请不要在此场景打出 error 级别。

9. 【强制】不允许记录日志后又抛出异常。因为这样会多次记录日志，只允许记录一次日志，应抛出异常，顶层打印一次日志。

   **反例**

   ```java
   try {
   　　// 错误
   } catch (Exception e) {
   　　log.error("xxxxxx", e);
   　　throw e；
   }
   ```

10. 【强制】禁止system.out 用于日志记录。

11. 【强制】日志中不允许出现计算或方法调用，防止在打印日志的时候报错。

12. 【强制】输出的POJO类必须重写toString方法，否则只输出对象的hashCode值，没有参考意义。

13. 【强制】不可以讲敏感业务信息记录入日志文件。

14. 【强制】不记录对于排查故障毫无意义的日志信息，日志信息一定要带有业务信息。

    ```java
    //错误
    log.error(“handle failed“);
    //正确
    log.error(“handle failed，id= {}“, id);
    ```

    